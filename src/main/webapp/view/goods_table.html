<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
    <!-- <script src="../layui/layui.all.js"></script> -->
    <script src="../layui/layui.js"></script>
    <script src="../js/jquery-3.3.1.js"></script>
    <script src="../js/common.js"></script>
    <style>
        #name {
            float: left;
            width: 14%;
            margin-top: 1.4%;
        }

        #search {
            margin-top: 1.4%;
            margin-left: 2px;
        }
    </style>
</head>

<body>
    <!-- 查询-->
    <div class="layui-row">
        <form class="layui-form layui-col-md12 x-so" id="ad_search">
            <p style="float: left; margin:2% 0% 5px 1%;">搜索奶茶：</p><input id="name" type="text" name="name"
                placeholder="请输入奶茶名称" autocomplete="off" class="layui-input">
            <button id="search" class="layui-btn" lay-submit="" lay-filter="search"><i
                    class="layui-icon">&#xe615;</i></button>
        </form>
    </div>
    <!-- 
        此处的 lay-filte="userTable" 
        对应下面jstable.on('toolbar(userTable)'..
    -->
    <table class="layui-hide" id="userTable" lay-filter="userTable"></table>

    <!-- 头部工具栏按钮开始 -->
    <div style="display:none;" id="userToolBar">
        <!-- 在此处添加lay-event事件（add，delete） -->
        <button type="button" class="layui-btn layui-btn-sm " lay-event="add"><i class="layui-icon"></i>添加</button>
        <button type="button" class="layui-btn layui-btn-sm" lay-event="delete"><i class="layui-icon"></i>批量删除</button>
    </div>
    <!-- 头部工具栏按钮开始结束 -->

    <!-- 行工具栏按钮开始 -->
    <div id="userBar" style="display:none;">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail"><i class="layui-icon">&#xe63c;</i>查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon">&#xe642;编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon">&#xe640;</i>删除</a>
    </div>
    <!-- 行工具栏按钮开始 -->

    <!-- 添加区域开始 -->
    <div class="layui-row" id="formBox" style="display:none;position: absolute;top: 0; left: 0; bottom: 0; right: 0;">
        <div class="layui-col-md11">
            <form id="ad_form" class="layui-form" action="" style="margin-top: 20px;align:center;">
                <!--隐藏字段id,区分添加和修改-->
                <input type="hidden" name="id" />
                <!-- lay-verify验证的值：
                        required（必填项）,phone（手机号）,email（邮箱）
                        url（网址）,number（数字）,date（日期）,identity（身份证）
                        自定义值 -->
                <div class="layui-form-item">
                    <label class="layui-form-label">奶茶名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="sname" id="sname" lay-verify="required" placeholder="请输入奶茶名称"
                            autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">奶茶价格</label>
                    <div class="layui-input-block">
                        <input type="text" name="sprice" id="sprice" lay-verify="number" placeholder="请输入奶茶价格(元)"
                            autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">奶茶原材料</label>
                    <div class="layui-input-block">
                        <input type="text" name="materials" lay-verify="required" placeholder="请输入奶茶原材料"
                            autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">产品描述</label>
                    <div class="layui-input-block">
                        <input type="text" name="introduction" lay-verify="" placeholder="请输入产品描述" autocomplete="off"
                            class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-top: 6%;margin-left: 34%;">
                        <button type="submit" class="layui-btn" lay-submit="" lay-filter="ad_submit"
                            @click="submit()">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
            </form>
        </div>
    </div>
    <!-- 添加区域结束 -->
    <div id="test1"></div>

    <script>
        $(function () {
            var index;//layer.open 打开窗口后的索引，通过layer.close(index)的方法可关闭
            //表单弹出层
            function ad_form(title, url, w, h) {
                if (title == null || title == '') { title = false; };
                if (url == null || url == '') { };// url="404.html";
                if (w == null || w == '') { w = ($(window).width() * 0.9); };
                if (h == null || h == '') { h = ($(window).height() - 50); };
                index = layer.open({  //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                    type: 1,
                    title: title,
                    area: ['450px', '350px'],//类型：String/Array，默认：'auto'  只有在宽高都定义的时候才不会自适应
                    // area: [w+'px', h +'px'],
                    fix: false, //不固定
                    maxmin: true,//开启最大化最小化按钮
                    shadeClose: true,//点击阴影处可关闭
                    shade: 0.3,//背景灰度
                    skin: 'layui-layer-rim', //加上边框
                    content: $("#formBox").html()
                });
            }
            layui.use(['table', 'jquery', 'layer', 'form', 'laypage'], function () {
                var table = layui.table;//表格
                var $ = layui.jquery;
                var form = layui.form;//表单
                var layer = layui.layer;//弹层
                var laypage = layui.laypage; //分页

                // 分页
                // laypage.render({
                //     elem: 'userTable',//注意，这里的 test1 是 ID，不用加 # 号
                //     count: 50,//数据总数，从服务端得到
                //     // limit: limit,
                //     limit: 16,
                //     curr: 1,
                //     // curr: current_page,
                //     theme: '#4e66f1'
                // });

                // 表格
                table.render({
                    elem: '#userTable',  //渲染目标对象
                    id: 'tableReload',//表格重载
                    url: '../GoodsServlet',  //数据接口
                    method: 'post',
                    dataType: "json",
                    title: '奶茶用品列表',//数据导出时的标题
                    toolbar: "#userToolBar", //开启头工具栏
                    even: true, //隔行背景
                    cellMinWidth: 80, //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    page: true, //开启分页
                    limit: 15, //每页默认显示条数
                    // where: {//发送条件值
                    //     id: 1,
                    // },
                    limits: [15, 25, 35, 45, 55],//下拉框页码中的值，
                    parseData: function (res) {
                        console.log(res);
                        return {
                            "code": 0, //数据状态
                            "msg": "", //状态信息
                            "count": "30",//数据总数
                            // "limits": [5, 10, 15],
                            data: res
                            // "code": res.status, //数据状态
                            // "msg": res.message, //状态信息
                            // "count": res.total,//数据总数
                            // data: res.data.item//解析数据列表
                        }
                    },
                    cols: [[
                        { type: 'checkbox', fixed: 'left', LAY_CHECKED: 'true' },
                        { field: 'id', width: "5%", title: 'ID', unresize: true, sort: true }
                        , { field: 'sname', width: "12%", title: '奶茶名称' }
                        , { field: 'sprice', width: "6%", title: '价格 ', sort: true }
                        , { field: 'materials', width: "26.6%", title: '奶茶原材料' }
                        , { field: 'introduction', title: '介绍说明', width: '30%' }
                        , { fixed: 'right', title: '操作', toolbar: '#userBar', width: "17%" }
                    ]],
                    done: function (res, curr, count) {
                        console.log(count);
                        // alert(count);//后台url返回的json字符串 alert(curr);//当前页 alert(count);//数据总条数 
                    },
                });
                //监听行单击事件（单击事件：row 双击事件为：rowDouble）
                table.on('rowDouble(userTable)', function (obj) {
                    var data = obj.data;

                    layer.alert(JSON.stringify(data), {
                        title: '当前行数据：'
                    });

                    //标注选中样式
                    obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
                });
                // 监听头部工具栏事件
                table.on('toolbar(userTable)', function (obj) {
                    var checkStatus = table.checkStatus(obj.config.id)
                        , data = checkStatus.data; //获取选中的数据
                    //json字符串转换成Json数据 eval("("+jsonStr+")")  /JSON.parse(jsonStr)
                    data = eval("(" + JSON.stringify(data) + ")");
                    console.log(data);

                    switch (obj.event) {
                        case 'add':
                            layer.msg('添加');
                            ad_form('添加奶茶信息', 'url在本页面不需要管', '', '');//数据回显
                            $("#ad_form").setForm({ id: data.id, sname: data.sname, sprice: data.sprice, introduction: data.introduction, introduction: data.introduction });
                            // $("#ad_form").setForm({ id: '' });
                            break;
                        case 'delete':
                            layer.msg('批量删除');
                            if (data.length === 0) {
                                layer.msg('请至少选择1行', { icon: 2, time: 1500 });
                            } else {
                                layer.alert('您确认要删除' + data.length + '条数据吗？', {
                                    skin: 'layui-layer-molv' //样式类名layui-layer-lan或layui-layer-molv  自定义样式
                                    , closeBtn: 1    // 是否显示关闭按钮
                                    , anim: 1 //动画类型
                                    , btn: ['确定', '取消'] //按钮
                                    , icon: 2    // icon
                                    , yes: function () {
                                        // layer.msg('确定', { icon: 1, time: 1500 });
                                        for (var i = 0; i < data.length; i++) {
                                            console.debug("id:======" + data[i].id)
                                            //发送请求到后台
                                            $.post("../DeleteGoodsServlet", { id: data[i].id }, function (result) {
                                                if (result.code == "1") {//删除成功，刷新当前页表格
                                                    // obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                                                    layer.msg(result.msg, { icon: 1, time: 1500 });
                                                    // layer.close(index);
                                                    $(".layui-laypage-btn").click();//点击分页刷新当前页
                                                } else if (result.code == "-1") {  //删除失败
                                                    layer.alert(result.msg, { icon: 2 }, function () {
                                                        $(".layui-laypage-btn").click();
                                                        window.location.reload();
                                                    });
                                                }
                                            });
                                        }
                                        /*   //捉到所有被选中的，发异步进行删除
                                           layer.msg('删除成功', {icon: 1});
                                           $(".layui-form-checked").not('.header').parents('tr').remove();*/
                                    }
                                    , btn2: function () {
                                        layer.msg('好的,暂时不给您删除。', { icon: 1, time: 1500 });
                                    }
                                });

                            }
                            break;
                    };
                });

                // 右侧编辑和删除
                //监听工具条
                table.on('tool(userTable)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
                    var data = obj.data; //获得当前行数据
                    // console.log("+++++++++++");
                    // console.log(data);
                    // console.log("+++++++++++");
                    var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）                 
                    var tr = obj.tr; //获得当前行 tr 的DOM对象
                    if (layEvent === 'del') { //删除
                        // layer.msg("删除");
                        layer.confirm('真的删除行么', function (index) {
                            obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                            layer.close(index);
                            //向服务端发送删除指令
                            //向服务端发送删除指令，在这里可以使用Ajax异步
                            $.post("menu/delete", { id: data.id }, function (ret) {
                                if (ret.code == "1") {//删除成功，刷新当前页表格
                                    layer.msg(ret.msg, { icon: 1, time: 1500 }, function () {
                                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                                        layer.close(index);
                                        // $(".layui-laypage-btn").click();//点击分页刷新当前页
                                    });
                                } else if (ret.code == "-1") {  //删除失败
                                    layer.alert(ret.msg, { icon: 2 }, function () {
                                        layer.close(index);
                                        // $(".layui-laypage-btn").click();
                                        window.location.reload();
                                    });
                                }
                            })
                        });
                    } else if (layEvent === 'edit') { //编辑
                        layer.msg("编辑");
                        // console.log("===" + data.sname);
                        // console.log("===" + data.sprice);
                        ad_form('编辑奶茶信息', 'url这个值不管', 500, 400);
                        //数据回显
                        $("#ad_form").setForm({ id: data.id, sname: data.sname, sprice: data.sprice, introduction: data.introduction, introduction: data.introduction });
                    } else if (layEvent === 'detail') {
                        //json字符串转换成Json数据 eval("("+jsonStr+")")  /JSON.parse(jsonStr)
                        var jsonstr = JSON.stringify(data);//json数据转字符串  JSON.stringify(obj)
                        layer.alert(jsonstr);
                    }

                });
                // 监听单元格编辑
                table.on('edit(userTable)', function (obj) { //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"

                    var value = obj.value //得到修改后的值
                        , data = obj.data //得到所在行所有键值
                        , field = obj.field; //得到字段
                    layer.msg('[ID: ' + data.id + '] ' + field + ' 字段更改为：' + value);
                    console.log(obj.value); //得到修改后的值
                    console.log(obj.data); //当前编辑的字段名
                    console.log(obj.field); //所在行的所有相关数据  
                    //发送post请求更新数据
                    $.post("url?" + obj.field + "&id=" + obj.data.id, function (json) {

                    });
                });

                // 表单
                //监听提交 lay-filter="ad_submit"
                form.on('submit(ad_submit)', function (data) {
                    console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
                    console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
                    console.log(data.field) //当前from表单所提交的所有字段， 名值对形式：{name: value}
                    layer.msg(JSON.stringify(data.field));//表格数据序列化
                    var formData = data.field;
                    var id = formData.id,
                        sname = formData.sname,
                        sprice = formData.sprice,
                        materials = formData.materials,
                        introduction = formData.introduction;
                    $.ajax({
                        type: "post",  //数据提交方式（post/get）
                        url: "../AddGoodServlet",  //提交到的url
                        data: { "id": id, "sname": sname, "sprice": sprice, "materials": materials, "introduction": introduction },//提交的数据
                        dataType: "json",//返回的数据类型格式
                        success: function (msg) {
                            console.log(msg);//{msg:"success"}
                            console.log(msg.msg);//"success"

                            if (msg.msg == 'success') {  //成功
                                console.log("成功");
                                layer.msg(msg.msg, { icon: 1, time: 1500 });
                                table.reload('tableReload');//数据表格重载
                                layer.close(index);//关闭弹出层
                            } else {  //失败
                                layer.alert(msg.msg, { icon: 2 }, function () {
                                    // $(".layui-laypage-btn").click();//执行分页刷新当前页
                                    layer.close(index);
                                    // window.location.reload();
                                });
                            }
                        }
                    });
                    return false;//false：阻止表单跳转  true：表单跳转
                });
                //监听提交 lay-filter="search"
                form.on('submit(search)', function (data) {
                    console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
                    console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
                    console.log(data.field) //当前from表单所提交的所有字段， 名值对形式：{name: value}

                    layer.msg(JSON.stringify(data.field));//表格数据序列化

                    var formData = data.field;
                    console.debug(formData);
                    console.log(formData);

                    var name = formData.name, materials = formData.name;
                    console.log(name);
                    console.log(materials);
                    // layui有自带的ajax
                    // $.ajax({
                    //     url: '../GoodsServlet?action=select',//后台做模糊搜索接口路径
                    //     method: 'post',
                    //     data: { 'sname': name, 'materials': materials },
                    //     success: function (res) {
                    //         console.log(msg);//{msg:"success"}
                    //         console.log(msg.msg);//"success"

                    //         if (msg.msg == 'success') {  //成功
                    //             table.reload('tableReload');//数据表格重载
                    //             layer.close(index);//关闭弹出层
                    //         } else {  //失败
                    //             layer.alert(msg.msg, { icon: 2 }, function () {
                    //                 layer.close(index);
                    //                 // window.location.reload();
                    //             });
                    //         }
                    //     }
                    // })
                    // //数据表格重载
                    table.reload('tableReload', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                        , where: {//这里传参向后台
                            'sname': name,
                            'materials': materials
                        }
                        , url: '../SelectGoodServlet'//后台做模糊搜索接口路径
                        , method: 'post'
                        ,
                    });
                    return false;//false：阻止表单跳转  true：表单跳转
                });
            });
        });
    </script>
</body>

</html>